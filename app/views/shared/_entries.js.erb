var callback = function() {
    <% if @entries.length == 0 %>
        var entries = "<%= j render partial: "entries/no_entry" %>";
    <% else %>
        var entries = "<%= j render partial: "entries/entry", collection: @entries, cached: -> (entry) { [entry, entry.feed.custom_icon, entry.feed.favicon, "v2"] } %>";
    <% end %>

    <% if @append %>
        feedbin.appendEntries(entries);
    <% else %>
        feedbin.updateEntries(entries);
    <% end %>

    <% if @page_query %>
        feedbin.updatePager("<%= j will_paginate(@page_query) %>");
    <% else %>
        feedbin.updatePager("");
    <% end %>

    <% if @search %>
        feedbin.showSearchControls("<%= params[:sort] %>", "<%= @escaped_query %>", "<%= @saved_search_path %>", "<%= @search_message %>");
    <% else %>
        feedbin.hideSearch()
    <% end %>

    <% if @all_unread %>
        var unreads = <%= @entries.map {|entry| {id: entry.id, feed_id: entry.feed_id, published: entry.published.to_i}}.to_json.html_safe %>;
        feedbin.updateUnreads(<%= @all_unread ? "true" : "false" %>, unreads)
    <% end %>

    feedbin.formatEntries()
    feedbin.preloadEntries(<%= @entries.map{ |entry| entry.id }.to_json.html_safe %>, <%= @force_preload ? "true" : "false" %>);
    feedbin.markReadData.date = "<%= j last_unread_date %>";
    <% if @type %>
    feedbin.viewType = "<%= @type %>";
    <% else %>
    feedbin.viewType = null;
    <% end %>

    try {
      feedbin.loadMore();
    } catch (e) {
    }
}

if (feedbin.panelScrollComplete) {
  callback();
} else {
    var interval = setInterval(function() {
        if (feedbin.panelScrollComplete) {
            clearInterval(interval);
            callback();
        }
    }, 10);
}
